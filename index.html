<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DIESEL | Market & Payouts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #e9eaeb; font-family: 'Inter', sans-serif; }
        .diesel-card { background: #161920; border: 1px solid #2a2d33; transition: 0.3s; }
        .diesel-input { background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        .diesel-input:focus { border-color: #3b82f6; }
        .tab-btn { padding: 12px 24px; color: #555; font-weight: 800; text-transform: uppercase; font-size: 11px; cursor: pointer; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; background: rgba(59, 130, 246, 0.05); }
    </style>
</head>
<body class="min-h-screen">

    <nav class="border-b border-gray-800 p-4 bg-[#12161c] flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-3xl font-black text-blue-500 tracking-tighter italic">DIESEL <span class="text-[10px] text-white not-italic font-mono ml-2">PAYOUT SYSTEM</span></h1>
        <div id="user-info" class="hidden flex items-center gap-4">
            <span id="user-mail" class="text-xs font-mono text-blue-400"></span>
            <button onclick="auth.signOut()" class="text-[10px] text-red-500 font-bold uppercase">–í—ã—Ö–æ–¥</button>
        </div>
    </nav>

    <main class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div id="auth-screen" class="lg:col-span-12 flex justify-center py-20">
            <div class="bg-[#161920] p-8 rounded-2xl border border-gray-800 w-full max-w-sm shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center italic tracking-widest">DIESEL ACCESS</h2>
                <input type="email" id="auth-email" placeholder="Email" class="diesel-input mb-4">
                <input type="password" id="auth-pass" placeholder="Password" class="diesel-input mb-6">
                <div class="flex gap-2">
                    <button onclick="handleAuth('login')" class="w-1/2 bg-blue-600 py-3 rounded-xl font-bold">–í–û–ô–¢–ò</button>
                    <button onclick="handleAuth('reg')" class="w-1/2 bg-gray-800 py-3 rounded-xl font-bold">–†–ï–ì</button>
                </div>
            </div>
        </div>

        <div id="main-app" class="hidden lg:col-span-8 space-y-6">
            <div class="flex justify-between items-center border-b border-gray-800 pb-2">
                <div class="flex">
                    <div id="tab-store" onclick="switchTab('store')" class="tab-btn active">–ú–∞–≥–∞–∑–∏–Ω</div>
                    <div id="tab-lib" onclick="switchTab('lib')" class="tab-btn">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
                </div>
                <input type="text" id="search-input" oninput="syncStore()" placeholder="–ü–æ–∏—Å–∫..." class="bg-[#1c212b] border border-gray-700 rounded-lg px-4 py-2 text-sm w-64 outline-none">
            </div>
            <div id="game-list" class="grid gap-4"></div>
        </div>

        <div id="side-app" class="hidden lg:col-span-4 space-y-6">
            <div class="bg-[#1c212b] p-6 rounded-2xl border border-gray-800">
                <h3 class="font-bold mb-4 text-blue-400 uppercase text-xs tracking-widest">–°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–∞—á—É</h3>
                <input type="text" id="g-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã" class="diesel-input mb-2 text-sm">
                <input type="number" id="g-price" placeholder="–¶–µ–Ω–∞ –≤ ‚ÇΩ (0 = –ë–µ—Å–ø–ª–∞—Ç–Ω–æ)" class="diesel-input mb-2 text-sm">
                <div id="payout-box" class="hidden">
                    <input type="text" id="g-wallet" placeholder="–í–∞—à –Ω–æ–º–µ—Ä –¥–ª—è –≤—ã–ø–ª–∞—Ç (–°–ë–ü/–ö–∞—Ä—Ç–∞)" class="diesel-input mb-4 text-sm border-yellow-900">
                    <p class="text-[9px] text-yellow-600 mb-4 px-2 uppercase italic">–í—ã –ø–æ–ª—É—á–∏—Ç–µ 90% –æ—Ç –∫–∞–∂–¥–æ–π –ø—Ä–æ–¥–∞–∂–∏</p>
                </div>
                <button onclick="publish()" class="w-full bg-white text-black font-black py-2 rounded-lg hover:bg-blue-400 transition uppercase text-xs">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>

            <div class="bg-[#161920] p-6 rounded-2xl border border-dashed border-gray-700">
                <h3 class="font-bold mb-2 text-sm">üì° –†–∞–∑–¥–∞—á–∞ (Seed)</h3>
                <input type="file" id="p2p-file" class="text-xs text-gray-500 mb-4 block w-full">
                <div id="console" class="bg-black p-3 rounded h-40 overflow-y-auto font-mono text-[10px] text-gray-400 border border-gray-900">
                    > –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞...
                </div>
            </div>
        </div>
    </main>

    <div id="pay-modal" class="hidden fixed inset-0 bg-black/95 flex justify-center items-center z-50 p-4">
        <div class="bg-[#1c212b] p-8 rounded-3xl w-full max-w-sm border border-gray-700 shadow-2xl">
            <h2 class="text-xl font-black mb-1 text-center text-blue-500 uppercase">–û–ø–ª–∞—Ç–∞ ‚ÇΩ</h2>
            <div id="pay-split" class="bg-black/50 p-4 rounded-xl my-6 space-y-2 font-mono text-[10px]">
                </div>
            <div class="space-y-4">
                <input type="text" id="card-num" placeholder="0000 0000 0000 0000" class="diesel-input text-center tracking-widest">
                <button onclick="processPay()" class="w-full bg-blue-600 py-4 rounded-2xl font-black mt-2 shadow-xl">–ö–£–ü–ò–¢–¨</button>
                <button onclick="closePay()" class="w-full text-[10px] text-gray-600 font-bold uppercase pt-2">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6WFfRt_S4SSxVr1ivDrM4OrifqAlpnRo",
            authDomain: "diesel-c8b6a.firebaseapp.com",
            databaseURL: "https://diesel-c8b6a-default-rtdb.firebaseio.com",
            projectId: "diesel-c8b6a",
            storageBucket: "diesel-c8b6a.firebasestorage.app",
            messagingSenderId: "685123947136",
            appId: "1:685123947136:web:4252220efd4883039d3465"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let user = null, peer = null, myFile = null, activeGame = null;
        let activeTab = 'store';

        const log = (m, col = 'text-gray-500') => {
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${col}">> ${m}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–ö–ê–ó–û–ú –ü–û–õ–Ø –ö–û–®–ï–õ–¨–ö–ê ---
        document.getElementById('g-price').oninput = (e) => {
            const box = document.getElementById('payout-box');
            box.classList.toggle('hidden', parseInt(e.target.value) <= 0 || !e.target.value);
        };

        async function handleAuth(t) {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            try {
                if(t === 'reg') await auth.createUserWithEmailAndPassword(e, p);
                else await auth.signInWithEmailAndPassword(e, p);
            } catch(err) { alert(err.message); }
        }

        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('side-app').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-mail').innerText = u.email;
                initP2P();
                syncStore();
            } else { location.reload(); }
        });

        function switchTab(t) {
            activeTab = t;
            document.getElementById('tab-store').classList.toggle('active', t === 'store');
            document.getElementById('tab-lib').classList.toggle('active', t === 'lib');
            syncStore();
        }

        function initP2P() {
            peer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });
            peer.on('open', id => {
                log("–°–ï–¢–¨ –ê–ö–¢–ò–í–ù–ê", "text-green-500");
                db.ref(`users/${user.uid}`).update({ peerId: id, online: true });
            });
            peer.on('connection', conn => {
                conn.on('data', data => {
                    if(data.type === 'REQ' && myFile) conn.send({ type: 'FILE', file: myFile, name: myFile.name });
                });
            });
        }

        document.getElementById('p2p-file').onchange = e => { myFile = e.target.files[0]; log("–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–¥–∞—á–µ"); };

        function publish() {
            const t = document.getElementById('g-title').value;
            const p = parseInt(document.getElementById('g-price').value) || 0;
            const w = document.getElementById('g-wallet').value;

            if(!t) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
            if(p > 0 && !w) return alert("–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è 90% –æ–ø–ª–∞—Ç—ã");

            db.ref('games').push().set({
                title: t,
                price: p,
                wallet: p > 0 ? w : null,
                author: user.uid
            });
            
            document.getElementById('g-title').value = '';
            document.getElementById('g-price').value = '';
            document.getElementById('g-wallet').value = '';
            log("–ò–≥—Ä–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!", "text-blue-400");
        }

        function syncStore() {
            const query = document.getElementById('search-input').value.toLowerCase();
            db.ref('games').on('value', snap => {
                const list = document.getElementById('game-list');
                list.innerHTML = '';
                snap.forEach(child => {
                    const g = child.val();
                    const id = child.key;
                    if (!g.title.toLowerCase().includes(query)) return;

                    db.ref(`users/${user.uid}/purchases/${id}`).once('value', pSnap => {
                        const isBought = pSnap.exists();
                        const isMy = g.author === user.uid;
                        const isFree = !g.price || g.price == 0;

                        if (activeTab === 'lib') { if (!isBought && !isMy) return; }
                        else { if (isBought || isMy) return; }

                        let btn = '';
                        if (isBought || isMy || isFree) {
                            btn = `<button onclick="download('${id}')" class="bg-blue-600 px-6 py-2 rounded-xl text-[10px] font-black italic">–°–ö–ê–ß–ê–¢–¨</button>`;
                        } else {
                            btn = `<button onclick="openPay('${id}')" class="bg-white text-black px-6 py-2 rounded-xl text-[10px] font-black italic">${g.price} ‚ÇΩ</button>`;
                        }

                        list.innerHTML += `
                            <div class="diesel-card p-5 rounded-2xl flex justify-between items-center border-l-4 ${isMy ? 'border-l-yellow-600' : 'border-l-blue-600'}">
                                <div>
                                    <h4 class="text-xl font-black italic">${g.title}</h4>
                                    <p class="text-[9px] text-gray-500 uppercase">${isMy ? '–ú–æ–π –ø—Ä–æ–µ–∫—Ç' : (isFree ? '–ë–ï–°–ü–õ–ê–¢–ù–û' : '–¶–µ–Ω–∞: ' + g.price + ' ‚ÇΩ')}</p>
                                </div>
                                ${btn}
                            </div>`;
                    });
                });
            });
        }

        async function openPay(id) {
            const snap = await db.ref(`games/${id}`).get();
            activeGame = { ...snap.val(), id: id };
            
            const total = activeGame.price;
            const comm = (total * 0.1).toFixed(0);
            const authorPart = (total - comm).toFixed(0);

            document.getElementById('pay-split').innerHTML = `
                <div class="flex justify-between text-gray-400"><span>–ê–≤—Ç–æ—Ä (90%):</span> <span class="text-white">${authorPart} ‚ÇΩ</span></div>
                <div class="text-[8px] text-blue-900 mb-2 italic">–†–µ–∫–≤–∏–∑–∏—Ç—ã: ${activeGame.wallet}</div>
                <div class="flex justify-between text-gray-400"><span>DIESEL (10%):</span> <span class="text-white">${comm} ‚ÇΩ</span></div>
                <div class="text-[8px] text-blue-900 italic">–†–µ–∫–≤–∏–∑–∏—Ç—ã: 79940091828</div>
                <div class="border-t border-gray-800 mt-2 pt-2 flex justify-between font-bold text-blue-500"><span>–ò–¢–û–ì–û:</span> <span>${total} ‚ÇΩ</span></div>
            `;
            document.getElementById('pay-modal').classList.remove('hidden');
        }

        function closePay() { document.getElementById('pay-modal').classList.add('hidden'); }

        async function processPay() {
            if(document.getElementById('card-num').value.length < 16) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ä—Ç—É");
            
            const comm = (activeGame.price * 0.1).toFixed(0);
            const authorPart = activeGame.price - comm;

            log(`–¢–†–ê–ù–ó–ê–ö–¶–ò–Ø –£–°–ü–ï–®–ù–ê!`, "text-green-500");
            log(`${authorPart} ‚ÇΩ ‚Üí –ê–≤—Ç–æ—Ä—É (${activeGame.wallet})`, "text-gray-400");
            log(`${comm} ‚ÇΩ ‚Üí DIESEL (79940091828)`, "text-blue-400");

            await db.ref(`users/${user.uid}/purchases/${activeGame.id}`).set(true);
            closePay();
            switchTab('lib');
        }

        async function download(id) {
            log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏...");
            const gSnap = await db.ref(`games/${id}`).get();
            const g = gSnap.val();
            const pSnap = await db.ref(`users/${user.uid}/purchases/${id}`).get();
            
            if (!pSnap.exists() && g.author !== user.uid && g.price > 0) return alert("–°–Ω–∞—á–∞–ª–∞ –æ–ø–ª–∞—Ç–∏—Ç–µ –∏–≥—Ä—É");

            if(g.author === user.uid && myFile) {
                const a = document.createElement('a'); a.href = URL.createObjectURL(myFile); a.download = myFile.name; a.click();
                return;
            }

            const u = (await db.ref(`users/${g.author}`).get()).val();
            if(!u || !u.online) return alert("–°–∏–¥ –æ—Ñ—Ñ–ª–∞–π–Ω");

            const conn = peer.connect(u.peerId);
            conn.on('open', () => conn.send({ type: 'REQ' }));
            conn.on('data', data => {
                if(data.type === 'FILE') {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data.file])); a.download = data.name; a.click();
                    log("–ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê", "text-green-500");
                }
            });
        }
    </script>
</body>
</html>
