<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIESEL | P2P Cloud Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #e9eaeb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .diesel-card { background: #161920; border: 1px solid #2a2d33; transition: 0.3s; }
        .diesel-input { background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .diesel-input:focus { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .modal-active { display: flex !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="border-b border-gray-800 p-4 bg-[#12161c] flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-black text-blue-500 tracking-tighter italic">DIESEL</h1>
            <div id="status-p2p" class="text-[10px] font-mono text-gray-500 border border-gray-800 px-2 py-1 rounded uppercase">
                Offline
            </div>
        </div>
        <div id="user-display" class="hidden flex items-center gap-4">
            <span id="user-mail" class="text-xs font-bold text-blue-400 font-mono"></span>
            <button onclick="auth.signOut()" class="text-[10px] text-red-500 hover:underline uppercase">–í—ã–π—Ç–∏</button>
        </div>
    </nav>

    <main class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div id="auth-screen" class="lg:col-span-12 flex justify-center py-10">
            <div class="bg-[#161920] p-8 rounded-2xl border border-gray-800 w-full max-w-sm shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center tracking-tight">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Email" class="diesel-input">
                    <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å (6+ –∑–Ω–∞–∫–æ–≤)" class="diesel-input">
                    <div class="flex gap-2">
                        <button onclick="handleAuth('login')" class="w-1/2 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition">–í–û–ô–¢–ò</button>
                        <button onclick="handleAuth('reg')" class="w-1/2 bg-gray-800 hover:bg-gray-700 py-3 rounded-xl font-bold transition text-gray-300">–†–ï–ì</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="app-screen" class="hidden lg:col-span-8 space-y-6">
            <h2 class="text-xl font-black text-gray-500 uppercase italic tracking-widest">–ú–∞–≥–∞–∑–∏–Ω –∏–≥—Ä</h2>
            <div id="game-list" class="grid gap-4">
                </div>
        </div>

        <div id="side-screen" class="hidden lg:col-span-4 space-y-6">
            <div class="bg-[#1c212b] p-6 rounded-2xl border border-gray-800">
                <h3 class="font-bold mb-4 text-sm text-blue-400 uppercase">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h3>
                <input type="text" id="post-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã" class="diesel-input mb-3 text-sm">
                <input type="number" id="post-price" placeholder="–¶–µ–Ω–∞ (0 = –±–µ—Å–ø–ª–∞—Ç–Ω–æ)" class="diesel-input mb-4 text-sm">
                <button onclick="publishGame()" class="w-full bg-white text-black font-black py-2 rounded-lg hover:bg-blue-400 transition uppercase text-xs">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –±–∞–∑—É</button>
            </div>

            <div class="bg-[#161920] p-6 rounded-2xl border border-dashed border-gray-700 text-center">
                <h3 class="font-bold mb-2 text-sm">üì° –†–∞–∑–¥–∞—á–∞ (Seeding)</h3>
                <p class="text-[10px] text-gray-500 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å —Å–∏–¥–æ–º –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</p>
                <input type="file" id="p2p-file" class="text-xs text-gray-500 mb-4 block w-full">
                <div id="console" class="text-left bg-black p-3 rounded-lg h-32 overflow-y-auto font-mono text-[10px] text-gray-500 border border-gray-900">
                    > –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...
                </div>
            </div>
        </div>
    </main>

    <div id="pay-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex justify-center items-center z-50 p-4">
        <div class="bg-[#1c212b] border border-gray-700 p-8 rounded-3xl w-full max-w-sm shadow-2xl relative">
            <button onclick="closePay()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">&times;</button>
            <h2 class="text-xl font-black mb-6 text-center italic text-blue-500">DIESEL CHECKOUT</h2>
            <div class="space-y-4">
                <div class="diesel-input flex items-center gap-3">
                    <span class="opacity-30">üí≥</span>
                    <input type="text" id="card-n" placeholder="4444 4444 4444 4444" class="bg-transparent outline-none w-full tracking-widest">
                </div>
                <div class="flex gap-4">
                    <input type="text" placeholder="MM/YY" class="diesel-input text-center">
                    <input type="text" placeholder="CVC" class="diesel-input text-center">
                </div>
                <button onclick="processPay()" class="w-full bg-blue-600 hover:bg-blue-400 py-4 rounded-2xl font-black transition mt-4 shadow-lg shadow-blue-900/20">–û–ü–õ–ê–¢–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        // –¢–í–û–ò –î–ê–ù–ù–´–ï FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD6WFfRt_S4SSxVr1ivDrM4OrifqAlpnRo",
            authDomain: "diesel-c8b6a.firebaseapp.com",
            databaseURL: "https://diesel-c8b6a-default-rtdb.firebaseio.com",
            projectId: "diesel-c8b6a",
            storageBucket: "diesel-c8b6a.firebasestorage.app",
            messagingSenderId: "685123947136",
            appId: "1:685123947136:web:4252220efd4883039d3465"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let curU = null, myPeer = null, currentFile = null, activePayId = null;

        const writeLog = (msg, col = 'text-gray-500') => {
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${col}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        // --- –í–•–û–î –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ---
        async function handleAuth(type) {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(!email || pass.length < 6) return alert("–ü–æ—á—Ç–∞ –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤)");
            try {
                if(type === 'reg') await auth.createUserWithEmailAndPassword(email, pass);
                else await auth.signInWithEmailAndPassword(email, pass);
            } catch(e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                curU = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('side-screen').classList.remove('hidden');
                document.getElementById('user-display').classList.remove('hidden');
                document.getElementById('user-mail').innerText = user.email;
                initP2P();
                syncStore();
            } else {
                location.reload();
            }
        });

        // --- P2P –°–ï–¢–¨ ---
        function initP2P() {
            myPeer = new Peer({ config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });

            myPeer.on('open', id => {
                document.getElementById('status-p2p').innerHTML = `<span class="text-green-500">‚óè Online</span> ID: ${id.slice(0,6)}`;
                writeLog("P2P –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ", "text-green-500");
                db.ref(`users/${curU.uid}`).update({ peerId: id, online: true });
                db.ref(`users/${curU.uid}/online`).onDisconnect().set(false);
            });

            myPeer.on('connection', conn => {
                conn.on('data', data => {
                    if(data.type === 'REQ_FILE' && currentFile) {
                        writeLog(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é: ${currentFile.name}`, "text-blue-400");
                        conn.send({ file: currentFile, name: currentFile.name });
                    }
                });
            });

            myPeer.on('error', e => writeLog("WebRTC Error: " + e.type, "text-red-500"));
        }

        document.getElementById('p2p-file').onchange = e => {
            currentFile = e.target.files[0];
            writeLog("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –±—É—Ñ–µ—Ä —Ä–∞–∑–¥–∞—á–∏: " + currentFile.name, "text-yellow-500");
        };

        // --- –ú–ê–ì–ê–ó–ò–ù –ò –û–ü–õ–ê–¢–ê ---
        function publishGame() {
            const t = document.getElementById('post-title').value;
            const p = document.getElementById('post-price').value || 0;
            if(!t) return;
            db.ref('games').push().set({ title: t, price: p, author: curU.uid });
            document.getElementById('post-title').value = '';
        }

        function syncStore() {
            db.ref('games').on('value', snap => {
                const list = document.getElementById('game-list');
                list.innerHTML = '';
                snap.forEach(child => {
                    const g = child.val();
                    const gId = child.key;
                    const isFree = parseInt(g.price) === 0;

                    db.ref(`users/${curU.uid}/purchases/${gId}`).once('value', pSnap => {
                        const hasAccess = pSnap.exists() || g.author === curU.uid || isFree;
                        
                        list.innerHTML += `
                            <div class="diesel-card p-5 rounded-2xl flex justify-between items-center">
                                <div>
                                    <h4 class="text-xl font-bold">${g.title}</h4>
                                    <p class="text-[10px] text-gray-600 uppercase tracking-tighter">SID: ${g.author.slice(0,10)}... ${isFree ? '| <span class="text-green-500 font-bold">FREE</span>' : ''}</p>
                                </div>
                                <div>
                                    ${hasAccess ? 
                                        `<button onclick="download('${gId}')" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl text-xs font-black transition">–°–ö–ê–ß–ê–¢–¨</button>` : 
                                        `<button onclick="openPay('${gId}')" class="bg-white text-black px-6 py-2 rounded-xl text-xs font-black hover:bg-green-400 transition">$ ${g.price}</button>`
                                    }
                                </div>
                            </div>`;
                    });
                });
            });
        }

        function openPay(id) { activePayId = id; document.getElementById('pay-modal').classList.add('modal-active'); }
        function closePay() { document.getElementById('pay-modal').classList.remove('modal-active'); }

        async function processPay() {
            if(document.getElementById('card-n').value.length < 10) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–∞—Ä—Ç—É");
            writeLog("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞...", "text-green-500");
            await db.ref(`users/${curU.uid}/purchases/${activePayId}`).set(true);
            closePay();
        }

        async function download(id) {
            writeLog("–°–≤—è–∑—å —Å —Å–∏–¥–æ–º...", "text-yellow-500");
            const g = (await db.ref(`games/${id}`).get()).val();
            
            // –ï—Å–ª–∏ –∫–∞—á–∞–µ–º —Å–≤–æ—ë –∂–µ
            if(g.author === curU.uid && currentFile) {
                const a = document.createElement('a'); a.href = URL.createObjectURL(currentFile); a.download = currentFile.name; a.click();
                return;
            }

            const u = (await db.ref(`users/${g.author}`).get()).val();
            if(!u || !u.online) return alert("–ê–≤—Ç–æ—Ä (—Å–∏–¥) —Å–µ–π—á–∞—Å Offline. –ù–µ–∫–æ–º—É —Ä–∞–∑–¥–∞—Ç—å —Ñ–∞–π–ª.");

            const conn = myPeer.connect(u.peerId);
            conn.on('open', () => {
                writeLog("–ö–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç, –∫–∞—á–∞—é –ø–∞–∫–µ—Ç—ã...");
                conn.send({ type: 'REQ_FILE' });
            });
            conn.on('data', data => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data.file]));
                a.download = data.name;
                a.click();
                writeLog("–ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫.", "text-green-500");
            });
        }
    </script>
</body>
</html>
