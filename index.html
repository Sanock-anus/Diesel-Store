<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DIESEL | P2P Cloud Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #e9eaeb; font-family: 'Segoe UI', sans-serif; }
        .diesel-card { background: #161920; border: 1px solid #2a2d33; transition: 0.3s; }
        .diesel-input { background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 6px; width: 100%; outline: none; }
        .diesel-input:focus { border-color: #3b82f6; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="border-b border-gray-800 p-4 bg-[#12161c] flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-4">
            <h1 class="text-3xl font-black text-blue-500 tracking-tighter italic">DIESEL</h1>
            <div id="status-dot" class="flex items-center gap-2 text-[10px] uppercase tracking-widest text-gray-500">
                <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span> Offline
            </div>
        </div>
        <div id="user-info" class="hidden text-right">
            <p id="display-email" class="text-xs font-bold text-blue-400"></p>
            <button onclick="logout()" class="text-[10px] uppercase text-gray-500 hover:text-white transition">–í—ã–π—Ç–∏</button>
        </div>
    </nav>

    <main class="container mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div id="auth-box" class="lg:col-span-12 flex justify-center py-20">
            <div class="bg-[#161920] p-8 rounded-2xl border border-gray-800 w-full max-w-sm shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                <input type="email" id="email" placeholder="Email" class="diesel-input mb-4">
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="diesel-input mb-6">
                <div class="flex gap-2">
                    <button onclick="authAction('login')" class="w-1/2 bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition">–í–æ–π—Ç–∏</button>
                    <button onclick="authAction('reg')" class="w-1/2 bg-gray-800 hover:bg-gray-700 py-3 rounded-xl font-bold transition text-sm text-gray-300">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
                <p id="auth-err" class="text-red-500 text-[10px] mt-4 text-center"></p>
            </div>
        </div>

        <div id="diesel-app" class="hidden lg:col-span-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black uppercase italic text-gray-400">–ö–∞—Ç–∞–ª–æ–≥ –∏–≥—Ä</h2>
                <div class="text-[10px] text-gray-600">–û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò</div>
            </div>
            <div id="store-list" class="grid gap-4">
                </div>
        </div>

        <div id="diesel-side" class="hidden lg:col-span-4 space-y-6">
            <div class="bg-[#1c212b] p-6 rounded-2xl border border-gray-800 shadow-lg">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <span class="text-blue-500 text-xl">üöÄ</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–≥—Ä—É
                </h3>
                <input type="text" id="g-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã" class="diesel-input mb-3 text-sm">
                <input type="number" id="g-price" placeholder="–¶–µ–Ω–∞ –≤ $" class="diesel-input mb-4 text-sm">
                <button onclick="publishGame()" class="w-full bg-white text-black font-black py-2 rounded-lg hover:bg-blue-400 transition uppercase text-xs">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –æ–±–ª–∞–∫–µ</button>
            </div>

            <div class="bg-[#161920] p-6 rounded-2xl border border-dashed border-gray-700">
                <h3 class="font-bold mb-2 text-sm">üì° –†–∞–∑–¥–∞—á–∞ (Seed)</h3>
                <input type="file" id="seed-file" class="text-xs text-gray-500 mb-4 block w-full">
                <div id="log" class="bg-black/50 p-3 rounded-lg h-32 overflow-y-auto font-mono text-[10px] text-gray-400 border border-gray-900">
                    > –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6WFfRt_S4SSxVr1ivDrM4OrifqAlpnRo",
            authDomain: "diesel-c8b6a.firebaseapp.com",
            databaseURL: "https://diesel-c8b6a-default-rtdb.firebaseio.com",
            projectId: "diesel-c8b6a",
            storageBucket: "diesel-c8b6a.firebasestorage.app",
            messagingSenderId: "685123947136",
            appId: "1:685123947136:web:4252220efd4883039d3465"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentU = null, peer = null, myFile = null;

        const writeLog = (m, c = 'text-gray-500') => {
            const l = document.getElementById('log');
            l.innerHTML += `<div class="${c}">> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---
        async function authAction(t) {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            if(!e || !p) return;
            try {
                if(t === 'reg') await auth.createUserWithEmailAndPassword(e, p);
                else await auth.signInWithEmailAndPassword(e, p);
            } catch(err) { document.getElementById('auth-err').innerText = err.message; }
        }

        function logout() { auth.signOut(); location.reload(); }

        auth.onAuthStateChanged(user => {
            if(user) {
                currentU = user;
                document.getElementById('auth-box').classList.add('hidden');
                document.getElementById('diesel-app').classList.remove('hidden');
                document.getElementById('diesel-side').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('display-email').innerText = user.email;
                initP2P();
                loadStore();
            }
        });

        // --- P2P –°–ï–¢–¨ ---
        function initP2P() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ STUN –¥–ª—è –æ–±—Ö–æ–¥–∞ NAT (–∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É webrtc)
            peer = new Peer({
                config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}
            });

            peer.on('open', id => {
                document.getElementById('status-dot').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
                writeLog("ID —Å–µ—Ç–∏ –∞–∫—Ç–∏–≤–µ–Ω: " + id, "text-green-500");
                db.ref(`users/${currentU.uid}`).update({ peerId: id, online: true });
                db.ref(`users/${currentU.uid}/online`).onDisconnect().set(false);
            });

            peer.on('connection', conn => {
                conn.on('data', data => {
                    if(data.type === 'REQ' && myFile) {
                        writeLog("–ü–µ—Ä–µ–¥–∞—é —Ñ–∞–π–ª: " + myFile.name, "text-blue-400");
                        conn.send({ file: myFile, name: myFile.name });
                    }
                });
            });

            peer.on('error', e => writeLog("–û—à–∏–±–∫–∞ P2P: " + e.type, "text-red-500"));
        }

        document.getElementById('seed-file').onchange = e => {
            myFile = e.target.files[0];
            writeLog("–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–¥–∞—á–µ: " + myFile.name, "text-yellow-500");
        };

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        function publishGame() {
            const t = document.getElementById('g-title').value;
            const p = document.getElementById('g-price').value;
            if(!t) return;
            db.ref('games').push().set({ title: t, price: p, author: currentU.uid });
            document.getElementById('g-title').value = '';
        }

        function loadStore() {
            db.ref('games').on('value', snap => {
                const list = document.getElementById('store-list');
                list.innerHTML = '';
                const data = snap.val();
                if(!data) return;
                Object.keys(data).forEach(id => {
                    const g = data[id];
                    db.ref(`users/${currentU.uid}/purchases/${id}`).once('value', pSnap => {
                        const bought = pSnap.exists() || g.author === currentU.uid;
                        list.innerHTML += `
                            <div class="diesel-card p-4 rounded-xl flex justify-between items-center shadow-lg border-l-4 ${bought ? 'border-l-blue-500' : 'border-l-transparent'}">
                                <div>
                                    <h4 class="font-black text-lg tracking-tight">${g.title}</h4>
                                    <p class="text-[10px] text-gray-600 uppercase">Vendor: ${g.author.slice(0,8)}</p>
                                </div>
                                ${bought ? 
                                    `<button onclick="download('${id}')" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-xs font-bold transition">–°–ö–ê–ß–ê–¢–¨</button>` : 
                                    `<button onclick="buy('${id}')" class="bg-white text-black px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-400 transition">$ ${g.price}</button>`
                                }
                            </div>`;
                    });
                });
            });
        }

        function buy(id) {
            if(confirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É?")) db.ref(`users/${currentU.uid}/purchases/${id}`).set(true);
        }

        async function download(id) {
            writeLog("–ò—â—É —Å–∏–¥–∞...", "text-yellow-500");
            const g = (await db.ref(`games/${id}`).get()).val();
            const u = (await db.ref(`users/${g.author}`).get()).val();

            if(!u || !u.online) return alert("–ê–≤—Ç–æ—Ä —Å–µ–π—á–∞—Å –Ω–µ —Ä–∞–∑–¥–∞–µ—Ç –∏–≥—Ä—É (Offline)");

            const conn = peer.connect(u.peerId);
            conn.on('open', () => conn.send({ type: 'REQ' }));
            conn.on('data', data => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data.file]));
                a.download = data.name;
                a.click();
                writeLog("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", "text-green-500");
            });
        }
    </script>
</body>
</html>
