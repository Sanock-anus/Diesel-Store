<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DIESEL PRO | Game Distribution Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0c0f17 0%, #1a1e2d 100%); 
            color: #e9eaeb; 
            font-family: 'Inter', sans-serif; 
        }
        .steam-card { 
            background: rgba(23, 26, 33, 0.8); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        .steam-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }
        .steam-input { 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; 
            padding: 14px; 
            border-radius: 8px; 
            width: 100%; 
            outline: none;
            transition: all 0.3s ease;
        }
        .steam-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .tab-btn { 
            padding: 16px 24px; 
            color: #9ca3af; 
            font-weight: 600; 
            cursor: pointer; 
            position: relative;
            transition: all 0.3s ease;
        }
        .tab-btn:hover { color: #3b82f6; }
        .tab-btn.active { 
            color: #3b82f6; 
            background: rgba(59, 130, 246, 0.1);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
        }
        .download-progress {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/10">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <h1 class="text-3xl font-black tracking-tighter">
                        <span class="gradient-text">DIESEL</span>
                        <span class="text-white/60 text-sm ml-2">PRO</span>
                    </h1>
                    <div class="hidden md:flex space-x-6">
                        <a href="#" class="text-gray-300 hover:text-white transition">–ú–∞–≥–∞–∑–∏–Ω</a>
                        <a href="#" class="text-gray-300 hover:text-white transition">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</a>
                        <a href="#" class="text-gray-300 hover:text-white transition">–°–æ–æ–±—â–µ—Å—Ç–≤–æ</a>
                        <a href="#" class="text-gray-300 hover:text-white transition">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                    </div>
                </div>
                <div id="user-info" class="hidden flex items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span id="user-avatar" class="text-white font-bold text-sm"></span>
                        </div>
                        <span id="user-mail" class="text-sm font-medium"></span>
                    </div>
                    <button onclick="auth.signOut()" class="text-red-400 hover:text-red-300 transition text-sm font-medium">
                        –í—ã—Ö–æ–¥
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8">
        <div id="auth-screen" class="min-h-[70vh] flex items-center justify-center">
            <div class="steam-card p-8 rounded-3xl w-full max-w-md">
                <h2 class="text-3xl font-bold mb-8 text-center">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Email" class="steam-input">
                    <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="steam-input">
                    <div class="flex gap-3 pt-4">
                        <button onclick="handleAuth('login')" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 py-3 rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 transition">
                            –í–æ–π—Ç–∏
                        </button>
                        <button onclick="handleAuth('reg')" class="flex-1 bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20 transition">
                            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-6">
                    <div class="steam-card p-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex">
                                <div id="tab-store" onclick="switchTab('store')" class="tab-btn active">üéÆ –ú–∞–≥–∞–∑–∏–Ω</div>
                                <div id="tab-lib" onclick="switchTab('lib')" class="tab-btn">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
                                <div id="tab-dev" onclick="switchTab('dev')" class="tab-btn">üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º</div>
                            </div>
                            <div class="relative w-full md:w-64">
                                <input type="text" id="search-input" oninput="syncStore()" placeholder="–ü–æ–∏—Å–∫ –∏–≥—Ä..." 
                                       class="steam-input pl-10">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" 
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div id="game-list" class="grid gap-6"></div>
                </div>

                <div class="lg:col-span-4 space-y-6">
                    <div id="dev-panel" class="steam-card p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span>üöÄ</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏–≥—Ä—É
                        </h3>
                        <div class="space-y-4">
                            <input type="text" id="g-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã" class="steam-input">
                            <textarea id="g-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã" rows="3" class="steam-input"></textarea>
                            <input type="number" id="g-price" placeholder="–¶–µ–Ω–∞ –≤ ‚ÇΩ (0 = –ë–µ—Å–ø–ª–∞—Ç–Ω–æ)" class="steam-input">
                            <label class="block text-sm text-gray-400">–û–±–ª–æ–∂–∫–∞ –∏–≥—Ä—ã:</label>
                            <input type="file" id="g-image" accept="image/*" class="steam-input">
                            <label class="block text-sm text-gray-400">–§–∞–π–ª –∏–≥—Ä—ã (Archive/Installer):</label>
                            <input type="file" id="g-file" class="steam-input">
                            
                            <div id="payout-box" class="hidden space-y-4">
                                <input type="text" id="g-wallet" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–ø–ª–∞—Ç" class="steam-input">
                                <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-3">
                                    <p class="text-blue-300 text-sm">üí∞ –í—ã –ø–æ–ª—É—á–∏—Ç–µ 90% –æ—Ç –∫–∞–∂–¥–æ–π –ø—Ä–æ–¥–∞–∂–∏</p>
                                </div>
                            </div>
                            
                            <button onclick="publish()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 py-3 rounded-xl font-bold hover:from-green-700 hover:to-emerald-700 transition">
                                –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>

                    <div class="steam-card p-6">
                        <h3 class="text-lg font-bold mb-4">üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">–ü—Ä–æ–¥–∞–Ω–æ –∫–æ–ø–∏–π:</span>
                                <span id="sales-count" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                                <span id="earnings" class="font-bold text-green-400">0 ‚ÇΩ</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ:</span>
                                <span id="library-count" class="font-bold">0 –∏–≥—Ä</span>
                            </div>
                        </div>
                    </div>

                    <div class="steam-card p-6">
                        <h3 class="text-lg font-bold mb-4">üñ•Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–æ–≥</h3>
                        <div id="console" class="bg-black/50 p-4 rounded-lg h-32 overflow-y-auto font-mono text-sm">
                            > –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="pay-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="steam-card p-8 rounded-3xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">üí≥ –û–ø–ª–∞—Ç–∞</h2>
            
            <div id="game-info" class="mb-6 p-4 bg-white/5 rounded-xl">
                <h3 id="pay-game-title" class="text-lg font-bold"></h3>
                <p id="pay-game-price" class="text-2xl font-black gradient-text mt-2"></p>
            </div>

            <div class="space-y-4">
                <input type="text" id="card-num" placeholder="0000 0000 0000 0000" maxlength="19" class="steam-input text-center tracking-widest">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="card-date" placeholder="MM/YY" maxlength="5" class="steam-input">
                    <input type="text" id="card-cvv" placeholder="CVV" maxlength="3" class="steam-input">
                </div>
                <input type="text" id="card-holder" placeholder="–ò–º—è –Ω–∞ –∫–∞—Ä—Ç–µ" class="steam-input">
                
                <div class="bg-white/5 rounded-xl p-4 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                        <span id="pay-total"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>–ö–æ–º–∏—Å—Å–∏—è (10%):</span>
                        <span id="pay-fee"></span>
                    </div>
                    <div class="border-t border-white/10 pt-2 flex justify-between font-bold">
                        <span>–ò—Ç–æ–≥–æ:</span>
                        <span id="pay-final" class="gradient-text"></span>
                    </div>
                </div>
                
                <button onclick="processPay()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-4 rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 transition">
                    –û–ø–ª–∞—Ç–∏—Ç—å
                </button>
                <button onclick="closePay()" class="w-full bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <div id="download-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="steam-card p-8 rounded-3xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞</h2>
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span id="download-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                    <span id="download-percent">0%</span>
                </div>
                <div class="bg-white/10 rounded-full h-3 overflow-hidden">
                    <div id="download-progress" class="download-progress w-0"></div>
                </div>
            </div>
            <div id="download-speed" class="text-center text-sm text-gray-400 mb-4"></div>
            <button onclick="closeDownload()" class="w-full bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20 transition">
                –°–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6WFfRt_S4SSxVr1ivDrM4OrifqAlpnRo",
            authDomain: "diesel-c8b6a.firebaseapp.com",
            databaseURL: "https://diesel-c8b6a-default-rtdb.firebaseio.com",
            projectId: "diesel-c8b6a",
            storageBucket: "diesel-c8b6a.firebasestorage.app",
            messagingSenderId: "685123947136",
            appId: "1:685123947136:web:4252220efd4883039d3465"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let user = null, peer = null, activeGame = null;
        let activeTab = 'store';

        // –£—Ç–∏–ª–∏—Ç—ã
        const log = (m, col = 'text-gray-400') => {
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${col}">> ${new Date().toLocaleTimeString()} - ${m}</div>`;
            c.scrollTop = c.scrollHeight;
        };

        const formatBytes = (bytes) => {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–æ–ª—è –∫–æ—à–µ–ª—å–∫–∞
        document.getElementById('g-price').oninput = (e) => {
            const box = document.getElementById('payout-box');
            box.classList.toggle('hidden', parseInt(e.target.value) <= 0 || !e.target.value);
        };

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
        document.getElementById('card-num').oninput = (e) => {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        };

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∫–∞—Ä—Ç—ã
        document.getElementById('card-date').oninput = (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        };

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function handleAuth(t) {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            try {
                if(t === 'reg') await auth.createUserWithEmailAndPassword(e, p);
                else await auth.signInWithEmailAndPassword(e, p);
            } catch(err) { 
                alert(err.message); 
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                const avatar = document.getElementById('user-avatar');
                avatar.textContent = u.email.charAt(0).toUpperCase();
                
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-mail').innerText = u.email;
                
                initPeer();
                syncStore();
                updateStats();
            } else { 
                location.reload(); 
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            document.getElementById('dev-panel').classList.toggle('hidden', t !== 'dev');
            syncStore();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è "–æ–Ω–ª–∞–π–Ω" —Å—Ç–∞—Ç—É—Å–∞, –Ω–æ –Ω–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏)
        function initPeer() {
            peer = new Peer({ 
                config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } 
            });
            peer.on('open', id => {
                db.ref(`users/${user.uid}`).update({ 
                    peerId: id, 
                    online: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            });
        }

        // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∏–≥—Ä—ã
        async function publish() {
            const title = document.getElementById('g-title').value;
            const description = document.getElementById('g-description').value;
            const price = parseInt(document.getElementById('g-price').value) || 0;
            const wallet = document.getElementById('g-wallet').value;
            const imageFile = document.getElementById('g-image').files[0];
            const gameFile = document.getElementById('g-file').files[0];

            if(!title) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã");
            if(!description) return alert("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã");
            if(price > 0 && !wallet) return alert("–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç");
            if(!imageFile) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä—ã");
            if(!gameFile) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–≥—Ä—ã");

            try {
                log("üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
                
                const imageRef = storage.ref(`games/${Date.now()}_${imageFile.name}`);
                const imageSnapshot = await imageRef.put(imageFile);
                const imageUrl = await imageSnapshot.ref.getDownloadURL();
                
                const gameRef = storage.ref(`games/${Date.now()}_${gameFile.name}`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º uploadTask –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const uploadTask = gameRef.put(gameFile);
                
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: ${Math.round(progress)}%`);
                    }, 
                    (error) => {
                        log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message, "text-red-500");
                    }, 
                    async () => {
                        const gameUrl = await uploadTask.snapshot.ref.getDownloadURL();

                        const gameData = {
                            title: title,
                            description: description,
                            price: price,
                            wallet: price > 0 ? wallet : null,
                            author: user.uid,
                            authorEmail: user.email,
                            imageUrl: imageUrl,
                            gameUrl: gameUrl, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É!
                            fileSize: gameFile.size,
                            fileName: gameFile.name,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            downloads: 0
                        };

                        await db.ref('games').push().set(gameData);
                        
                        document.getElementById('g-title').value = '';
                        document.getElementById('g-description').value = '';
                        document.getElementById('g-price').value = '';
                        document.getElementById('g-image').value = '';
                        document.getElementById('g-file').value = '';
                        
                        log("‚úÖ –ò–≥—Ä–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!", "text-green-500");
                        alert("–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!");
                        switchTab('store');
                    }
                );
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "text-red-500");
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: " + error.message);
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
        function syncStore() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            db.ref('games').on('value', snap => {
                const list = document.getElementById('game-list');
                list.innerHTML = '';
                
                const games = [];
                snap.forEach(child => games.push({ id: child.key, ...child.val() }));
                games.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                games.forEach(game => {
                    if (!game.title.toLowerCase().includes(query)) return;
                    
                    db.ref(`users/${user.uid}/purchases/${game.id}`).once('value', pSnap => {
                        const isBought = pSnap.exists();
                        const isMy = game.author === user.uid;
                        const isFree = !game.price || game.price == 0;

                        if (activeTab === 'lib') { 
                            if (!isBought && !isMy) return; 
                        } else if (activeTab === 'store') {
                            if (isBought || isMy) return; 
                        }

                        let btn = '';
                        if (isBought || isMy || isFree) {
                            btn = `<button onclick="download('${game.id}')" class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-3 rounded-xl font-bold hover:from-blue-700 hover:to-purple-700 transition">–°–ö–ê–ß–ê–¢–¨</button>`;
                        } else {
                            btn = `<button onclick="openPay('${game.id}')" class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-3 rounded-xl font-bold hover:from-green-700 hover:to-emerald-700 transition">${game.price} ‚ÇΩ</button>`;
                        }
                        
                        list.innerHTML += `
                            <div class="steam-card p-6 hover:border-blue-500/50">
                                <div class="flex flex-col md:flex-row gap-6">
                                    <img src="${game.imageUrl || 'https://via.placeholder.com/200x120'}" 
                                         alt="${game.title}" class="w-full md:w-48 h-28 object-cover rounded-xl">
                                    <div class="flex-1">
                                        <div class="flex flex-col md:flex-row justify-between items-start mb-2 gap-4">
                                            <div>
                                                <h4 class="text-xl font-bold mb-1">${game.title}</h4>
                                                <p class="text-gray-400 text-sm mb-2">${game.description}</p>
                                                <div class="flex items-center gap-4 text-sm">
                                                    <span class="text-gray-500">üíæ ${formatBytes(game.fileSize || 0)}</span>
                                                    ${isMy ? '<span class="text-yellow-400">üëë –í–∞—à –ø—Ä–æ–µ–∫—Ç</span>' : ''}
                                                </div>
                                            </div>
                                            ${btn}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    });
                });
            });
        }

        // –û–ø–ª–∞—Ç–∞
        async function openPay(id) {
            const snap = await db.ref(`games/${id}`).get();
            activeGame = { ...snap.val(), id: id };
            
            document.getElementById('pay-game-title').textContent = activeGame.title;
            document.getElementById('pay-game-price').textContent = activeGame.price + ' ‚ÇΩ';
            document.getElementById('pay-total').textContent = activeGame.price + ' ‚ÇΩ';
            
            const fee = Math.round(activeGame.price * 0.1);
            const final = activeGame.price + fee;
            
            document.getElementById('pay-fee').textContent = fee + ' ‚ÇΩ';
            document.getElementById('pay-final').textContent = final + ' ‚ÇΩ';
            
            document.getElementById('pay-modal').classList.remove('hidden');
        }

        function closePay() { document.getElementById('pay-modal').classList.add('hidden'); }

        async function processPay() {
            const cardNum = document.getElementById('card-num').value;
            if(cardNum.length < 19) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã");

            try {
                log("üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...", "text-blue-400");
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                await db.ref(`users/${user.uid}/purchases/${activeGame.id}`).set({
                    purchasedAt: firebase.database.ServerValue.TIMESTAMP,
                    price: activeGame.price
                });

                await db.ref(`games/${activeGame.id}`).transaction(game => {
                    if (game) game.sales = (game.sales || 0) + 1;
                    return game;
                });

                closePay();
                switchTab('lib');
                updateStats();
                alert("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
                
            } catch (error) {
                alert("–û—à–∏–±–∫–∞: " + error.message);
            }
        }

        // --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –ó–ê–ì–†–£–ó–ö–ò (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
        async function download(id) {
            const gSnap = await db.ref(`games/${id}`).get();
            const g = gSnap.val();
            const pSnap = await db.ref(`users/${user.uid}/purchases/${id}`).get();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
            if (!pSnap.exists() && g.author !== user.uid && g.price > 0) {
                return alert("–°–Ω–∞—á–∞–ª–∞ –æ–ø–ª–∞—Ç–∏—Ç–µ –∏–≥—Ä—É");
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å—Å—ã–ª–∫–∏
            if (!g.gameUrl) {
                return alert("–û—à–∏–±–∫–∞: –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
            }

            try {
                log("üì• –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∑–∞–≥—Ä—É–∑–∫–∏...", "text-blue-400");
                openDownloadModal();

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º XMLHttpRequest –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const xhr = new XMLHttpRequest();
                xhr.responseType = 'blob';
                xhr.open('GET', g.gameUrl);

                xhr.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        // –†–∞—Å—Å—á–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                        const speed = (event.loaded / 1024 / 1024) / (event.timeStamp / 1000); 
                        updateDownloadProgress(percent, '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞...', speed);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const blob = xhr.response;
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = g.fileName || 'game_download';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        updateDownloadProgress(100, '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 0);
                        log("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω", "text-green-500");
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
                        db.ref(`games/${id}`).transaction(game => {
                            if (game) game.downloads = (game.downloads || 0) + 1;
                            return game;
                        });

                        setTimeout(closeDownload, 2000);
                    } else {
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${xhr.status}`);
                    }
                };

                xhr.onerror = () => {
                    log("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ", "text-red-500");
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
                    closeDownload();
                };

                xhr.send();

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, "text-red-500");
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: " + error.message);
                closeDownload();
            }
        }

        function updateDownloadProgress(percent, status, speed) {
            const p = Math.min(100, Math.max(0, percent));
            document.getElementById('download-progress').style.width = p + '%';
            document.getElementById('download-percent').textContent = Math.round(p) + '%';
            document.getElementById('download-status').textContent = status;
            if(speed > 0) {
                document.getElementById('download-speed').textContent = `${speed.toFixed(1)} MB/s`;
            }
        }

        function openDownloadModal() {
            document.getElementById('download-modal').classList.remove('hidden');
            updateDownloadProgress(0, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 0);
        }

        function closeDownload() {
            document.getElementById('download-modal').classList.add('hidden');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            if (!user) return;
            db.ref('games').orderByChild('author').equalTo(user.uid).on('value', snap => {
                let totalSales = 0;
                let totalEarnings = 0;
                snap.forEach(child => {
                    const game = child.val();
                    totalSales += game.sales || 0;
                    totalEarnings += (game.sales || 0) * (game.price || 0) * 0.9;
                });
                document.getElementById('sales-count').textContent = totalSales;
                document.getElementById('earnings').textContent = Math.round(totalEarnings) + ' ‚ÇΩ';
            });
            db.ref(`users/${user.uid}/purchases`).on('value', snap => {
                document.getElementById('library-count').textContent = snap.numChildren() + ' –∏–≥—Ä';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            log("üöÄ DIESEL PRO –∑–∞–ø—É—â–µ–Ω", "text-green-500");
        });
    </script>
</body>
</html>
