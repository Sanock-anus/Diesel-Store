<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DIESEL P2P | Decentralized Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0c0f17 0%, #1a1e2d 100%); 
            color: #e9eaeb; 
            font-family: 'Inter', sans-serif; 
        }
        .steam-card { 
            background: rgba(23, 26, 33, 0.9); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px;
        }
        .steam-input { 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            outline: none;
        }
        .steam-input:focus { border-color: #3b82f6; }
        .tab-btn { padding: 12px 20px; cursor: pointer; color: #9ca3af; font-weight: 600; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω */
        .online-dot {
            height: 10px; width: 10px; background-color: #22c55e; border-radius: 50%;
            box-shadow: 0 0 10px #22c55e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    </style>
</head>
<body class="min-h-screen">

    <nav class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter flex items-center gap-2">
                <span class="gradient-text">DIESEL</span> P2P
                <div id="connection-status" class="hidden text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 font-mono">OFFLINE</div>
            </h1>
            <div id="user-info" class="hidden flex items-center gap-4">
                <span id="my-peer-id" class="text-xs font-mono text-gray-500 hidden md:block" title="My Peer ID"></span>
                <span id="user-mail" class="text-sm font-bold"></span>
                <button onclick="auth.signOut()" class="text-red-400 hover:text-red-300 text-sm">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
    </nav>

    <div id="auth-screen" class="min-h-[80vh] flex items-center justify-center p-4">
        <div class="steam-card p-8 w-full max-w-md space-y-4">
            <h2 class="text-3xl font-bold text-center mb-6">–í—Ö–æ–¥ –≤ —Å–µ—Ç—å</h2>
            <input type="email" id="auth-email" placeholder="Email" class="steam-input">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" class="steam-input">
            <div class="flex gap-2">
                <button onclick="handleAuth('login')" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold transition">–í–æ–π—Ç–∏</button>
                <button onclick="handleAuth('reg')" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-lg font-bold transition">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden container mx-auto px-4 py-8">
        <div class="flex border-b border-white/10 mb-8 overflow-x-auto">
            <div id="tab-store" onclick="switchTab('store')" class="tab-btn active">üéÆ –ú–∞–≥–∞–∑–∏–Ω</div>
            <div id="tab-lib" onclick="switchTab('lib')" class="tab-btn">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
            <div id="tab-dev" onclick="switchTab('dev')" class="tab-btn">üì° –†–∞–∑–¥–∞—á–∞ (Dev)</div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div id="dev-panel" class="hidden space-y-6">
                    <div class="steam-card p-6">
                        <h3 class="text-xl font-bold mb-4">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</h3>
                        <div class="space-y-4">
                            <input type="text" id="g-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="steam-input">
                            <textarea id="g-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="steam-input h-24"></textarea>
                            <input type="number" id="g-price" placeholder="–¶–µ–Ω–∞ (0 = –±–µ—Å–ø–ª–∞—Ç–Ω–æ)" class="steam-input">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">–û–±–ª–æ–∂–∫–∞ (–≤ –æ–±–ª–∞–∫–æ):</label>
                                    <input type="file" id="g-image" accept="image/*" class="steam-input text-sm">
                                </div>
                                <div>
                                    <label class="text-sm text-green-400 mb-1 block">–§–∞–π–ª –∏–≥—Ä—ã (–æ—Å—Ç–∞–µ—Ç—Å—è —É –≤–∞—Å):</label>
                                    <input type="file" id="g-file" class="steam-input text-sm border-green-500/50">
                                </div>
                            </div>

                            <div class="bg-yellow-500/10 border border-yellow-500/20 p-4 rounded-lg text-sm text-yellow-200">
                                ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –§–∞–π–ª –∏–≥—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –í—ã –¥–æ–ª–∂–Ω—ã –¥–µ—Ä–∂–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –æ—Ç–∫—Ä—ã—Ç–æ–π, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —Å–∫–∞—á–∞—Ç—å –∏–≥—Ä—É —Å –≤–∞—à–µ–≥–æ –ü–ö.
                            </div>

                            <button onclick="publishGame()" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold transition">
                                –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–∑–¥–∞—á—É
                            </button>
                        </div>
                    </div>

                    <div class="steam-card p-6">
                        <h3 class="text-xl font-bold mb-4">üì° –¶–µ–Ω—Ç—Ä —Ä–∞–∑–¥–∞—á–∏</h3>
                        <p class="text-sm text-gray-400 mb-4">–ó–¥–µ—Å—å —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∏–≥—Ä. –ï—Å–ª–∏ –≤—ã –æ–±–Ω–æ–≤–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª, —á—Ç–æ–±—ã –≤—Å—Ç–∞—Ç—å –Ω–∞ —Ä–∞–∑–¥–∞—á—É.</p>
                        <div id="seeding-list" class="space-y-3"></div>
                    </div>
                </div>

                <div id="game-list" class="grid gap-4"></div>
            </div>

            <div class="space-y-6">
                <div class="steam-card p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <div id="p2p-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                        –°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏
                    </h3>
                    <div class="text-sm space-y-2 text-gray-400">
                        <p>–í–∞—à ID: <span id="display-peer-id" class="font-mono text-white select-all">...</span></p>
                        <p>–†–∞–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª–æ–≤: <span id="hosting-count" class="text-white">0</span></p>
                        <p>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: <span id="conn-count" class="text-white">0</span></p>
                    </div>
                </div>

                <div class="steam-card p-4 bg-black/80 font-mono text-xs h-64 overflow-y-auto" id="console">
                    <div class="text-green-500">> System initialized...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="download-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[60]">
        <div class="steam-card p-8 max-w-md w-full text-center">
            <h2 class="text-2xl font-bold mb-2">üì• P2P –ó–∞–≥—Ä—É–∑–∫–∞</h2>
            <p id="dl-status" class="text-gray-400 mb-6 text-sm">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º...</p>
            
            <div class="w-full bg-white/10 rounded-full h-4 mb-2 overflow-hidden">
                <div id="dl-bar" class="bg-blue-500 h-full w-0 transition-all duration-200"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500 font-mono mb-6">
                <span id="dl-percent">0%</span>
                <span id="dl-speed">0 MB/s</span>
            </div>

            <button onclick="document.getElementById('download-modal').classList.add('hidden')" class="bg-white/10 hover:bg-white/20 py-2 px-6 rounded-lg transition">
                –°–≤–µ—Ä–Ω—É—Ç—å
            </button>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6WFfRt_S4SSxVr1ivDrM4OrifqAlpnRo",
            authDomain: "diesel-c8b6a.firebaseapp.com",
            databaseURL: "https://diesel-c8b6a-default-rtdb.firebaseio.com",
            projectId: "diesel-c8b6a",
            storageBucket: "diesel-c8b6a.firebasestorage.app",
            messagingSenderId: "685123947136",
            appId: "1:685123947136:web:4252220efd4883039d3465"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let user = null;
        let peer = null; // –û–±—ä–µ–∫—Ç PeerJS
        let hostedFiles = {}; // { gameId: FileObject } - –∑–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º —Ñ–∞–π–ª—ã –≤ RAM
        let activeTab = 'store';

        // --- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ---
        const log = (msg, type = 'info') => {
            const colors = { info: 'text-gray-400', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400' };
            const c = document.getElementById('console');
            c.innerHTML += `<div class="${colors[type]} mb-1">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        };

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        auth.onAuthStateChanged(u => {
            if (u) {
                user = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-mail').innerText = u.email;
                initP2P();
                loadGames();
                loadMySeedingList();
            } else {
                location.reload();
            }
        });

        async function handleAuth(type) {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            try {
                if (type === 'reg') await auth.createUserWithEmailAndPassword(e, p);
                else await auth.signInWithEmailAndPassword(e, p);
            } catch (err) { alert(err.message); }
        }

        // --- P2P –°–ò–°–¢–ï–ú–ê (PEERJS) ---
        function initP2P() {
            // –°–æ–∑–¥–∞–µ–º Peer ID –Ω–∞ –æ—Å–Ω–æ–≤–µ User ID (—á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–ª—è –ø–æ–∏—Å–∫–∞)
            // –ó–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã, –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –¥–ª—è PeerJS
            const cleanId = user.uid.replace(/[^a-zA-Z0-9]/g, '');
            peer = new Peer(cleanId, {
                config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', (id) => {
                log(`P2P –°–µ—Ç—å –≥–æ—Ç–æ–≤–∞. –í–∞—à ID: ${id}`, 'success');
                document.getElementById('display-peer-id').innerText = id;
                document.getElementById('p2p-indicator').classList.remove('bg-red-500');
                document.getElementById('p2p-indicator').classList.add('online-dot');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î, —á—Ç–æ –º—ã –æ–Ω–ª–∞–π–Ω
                db.ref(`users/${user.uid}`).update({ 
                    online: true, 
                    peerId: id,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP 
                });
            });

            // –û–ë–†–ê–ë–û–¢–ö–ê –í–•–û–î–Ø–©–ò–• –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô (–†–ê–ó–î–ê–ß–ê)
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    log(`üîó –í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ${conn.peer}`, 'info');
                    updateConnCount(1);
                });

                conn.on('data', (data) => {
                    // –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–∞–π–ª
                    if (data.type === 'REQUEST_FILE' && data.gameId) {
                        handleFileRequest(conn, data.gameId);
                    }
                });

                conn.on('close', () => updateConnCount(-1));
            });

            peer.on('error', err => log(`P2P –û—à–∏–±–∫–∞: ${err.type}`, 'error'));
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ (–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å P2P)
        async function handleFileRequest(conn, gameId) {
            const file = hostedFiles[gameId];
            
            if (!file) {
                conn.send({ type: 'ERROR', message: '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Ö–æ—Å—Ç–∞' });
                log(`‚ùå –ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–≥—Ä—É ${gameId}, –Ω–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –≤ –ø–∞–º—è—Ç–∏`, 'error');
                return;
            }

            log(`üì§ –ù–∞—á–∞–ª–æ –æ—Ç–¥–∞—á–∏ —Ñ–∞–π–ª–∞: ${file.name}`, 'success');
            conn.send({ 
                type: 'META', 
                size: file.size, 
                name: file.name,
                mime: file.type 
            });

            // –ß—Ç–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–∞–º–∏
            const CHUNK_SIZE = 16384; // 16KB (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è WebRTC)
            let offset = 0;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º FileReader –¥–ª—è —á—Ç–µ–Ω–∏—è
            const reader = new FileReader();
            
            const sendNextChunk = () => {
                if (offset < file.size) {
                    const slice = file.slice(offset, offset + CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                } else {
                    conn.send({ type: 'END' });
                    log(`‚úÖ –†–∞–∑–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è ${conn.peer}`, 'success');
                }
            };

            reader.onload = (e) => {
                conn.send({
                    type: 'CHUNK',
                    data: e.target.result
                });
                offset += CHUNK_SIZE;
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å –±—É—Ñ–µ—Ä –∫–∞–Ω–∞–ª–∞
                if (conn.bufferSize > 1024 * 1024) { // –ï—Å–ª–∏ –±—É—Ñ–µ—Ä > 1MB
                    setTimeout(sendNextChunk, 50);
                } else {
                    sendNextChunk();
                }
            };

            sendNextChunk();
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---

        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            
            document.getElementById('dev-panel').classList.toggle('hidden', t !== 'dev');
            loadGames(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
        }

        // 1. –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ò–ì–†–´
        async function publishGame() {
            const title = document.getElementById('g-title').value;
            const desc = document.getElementById('g-desc').value;
            const price = document.getElementById('g-price').value;
            const imgFile = document.getElementById('g-image').files[0];
            const gameFile = document.getElementById('g-file').files[0];

            if (!title || !gameFile || !imgFile) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");

            try {
                log("‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...", 'info');

                // 1. –ì—Ä—É–∑–∏–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ –æ–±–ª–∞–∫–æ (—ç—Ç–æ –æ–∫, –æ–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è)
                const imgRef = storage.ref(`covers/${Date.now()}_${imgFile.name}`);
                await imgRef.put(imgFile);
                const imgUrl = await imgRef.getDownloadURL();

                // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î (–ë–ï–ó –°–°–´–õ–ö–ò –ù–ê –§–ê–ô–õ –ò–ì–†–´)
                const newGameRef = db.ref('games').push();
                const gameId = newGameRef.key;

                await newGameRef.set({
                    title, description: desc, price: price || 0,
                    author: user.uid,
                    authorEmail: user.email,
                    imageUrl: imgUrl,
                    fileName: gameFile.name,
                    fileSize: gameFile.size,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });

                // 3. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å –¥–ª—è —Ä–∞–∑–¥–∞—á–∏
                hostedFiles[gameId] = gameFile;
                updateHostingCount();
                loadMySeedingList(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–∞—á

                log("‚úÖ –ò–≥—Ä–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞! –í—ã –Ω–∞ —Ä–∞–∑–¥–∞—á–µ.", 'success');
                alert("–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —Å–∫–∞—á–∞—Ç—å.");
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                document.getElementById('g-title').value = '';
                document.getElementById('g-file').value = '';

            } catch (e) {
                log("–û—à–∏–±–∫–∞: " + e.message, 'error');
            }
        }

        // 2. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ò–ì–†
        function loadGames() {
            const list = document.getElementById('game-list');
            list.innerHTML = '';
            
            db.ref('games').once('value', snap => {
                const games = [];
                snap.forEach(c => games.push({id: c.key, ...c.val()}));
                
                games.forEach(g => {
                    const isMine = g.author === user.uid;
                    if (activeTab === 'dev' && !isMine) return;
                    if (activeTab === 'lib') return; // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –≤—Å–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ

                    list.innerHTML += `
                        <div class="steam-card p-4 flex gap-4 hover:bg-white/5 transition">
                            <img src="${g.imageUrl}" class="w-32 h-20 object-cover rounded bg-gray-800">
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <h4 class="font-bold text-lg">${g.title}</h4>
                                    <span class="text-blue-400 font-bold">${g.price > 0 ? g.price + ' ‚ÇΩ' : 'Free'}</span>
                                </div>
                                <p class="text-gray-400 text-sm mb-2">${g.description}</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">üíø ${(g.fileSize/1024/1024).toFixed(1)} MB</span>
                                    ${isMine 
                                        ? '<span class="text-green-500 text-xs">–í–∞—à –ø—Ä–æ–µ–∫—Ç</span>' 
                                        : `<button onclick="startDownload('${g.id}', '${g.author}')" class="bg-blue-600 px-4 py-1 rounded text-sm hover:bg-blue-500">–°–ö–ê–ß–ê–¢–¨ (P2P)</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // 3. –õ–û–ì–ò–ö–ê "–¶–ï–ù–¢–†–ê –†–ê–ó–î–ê–ß–ò" (–ß—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –ø–æ—Å–ª–µ F5)
        function loadMySeedingList() {
            const container = document.getElementById('seeding-list');
            container.innerHTML = '';

            db.ref('games').orderByChild('author').equalTo(user.uid).once('value', snap => {
                snap.forEach(c => {
                    const g = c.val();
                    const gid = c.key;
                    const isHosted = !!hostedFiles[gid];

                    container.innerHTML += `
                        <div class="flex items-center justify-between bg-black/30 p-3 rounded border ${isHosted ? 'border-green-500/30' : 'border-red-500/30'}">
                            <div>
                                <div class="font-bold">${g.title}</div>
                                <div class="text-xs ${isHosted ? 'text-green-400' : 'text-red-400'}">
                                    ${isHosted ? 'üü¢ –†–∞–∑–¥–∞–µ—Ç—Å—è' : 'üî¥ –ù–µ —Ä–∞–∑–¥–∞–µ—Ç—Å—è (–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª)'}
                                </div>
                            </div>
                            ${!isHosted ? `
                                <div class="relative overflow-hidden">
                                    <button class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded text-xs">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                                    <input type="file" onchange="restoreSeed('${gid}', this)" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            });
        }

        function restoreSeed(gameId, input) {
            if (input.files[0]) {
                hostedFiles[gameId] = input.files[0];
                updateHostingCount();
                loadMySeedingList();
                log(`–§–∞–π–ª –¥–ª—è –∏–≥—Ä—ã ${gameId} –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–∞–º—è—Ç—å.`, 'success');
            }
        }

        // 4. –°–ö–ê–ß–ò–í–ê–ù–ò–ï (–ö–õ–ò–ï–ù–¢)
        async function startDownload(gameId, authorUid) {
            log("üîé –ü–æ–∏—Å–∫ –∞–≤—Ç–æ—Ä–∞ –≤ —Å–µ—Ç–∏...", 'info');
            
            // 1. –ü–æ–ª—É—á–∞–µ–º PeerId –∞–≤—Ç–æ—Ä–∞ –∏–∑ –±–∞–∑—ã
            const snap = await db.ref(`users/${authorUid}`).get();
            const authorData = snap.val();

            if (!authorData || !authorData.peerId) {
                return alert("–ê–≤—Ç–æ—Ä –∏–≥—Ä—ã —Å–µ–π—á–∞—Å –æ—Ñ—Ñ–ª–∞–π–Ω. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.");
            }

            const modal = document.getElementById('download-modal');
            modal.classList.remove('hidden');
            const statusEl = document.getElementById('dl-status');
            const barEl = document.getElementById('dl-bar');

            statusEl.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ü–ö –∞–≤—Ç–æ—Ä–∞...";

            // 2. –°–æ–µ–¥–∏–Ω—è–µ–º—Å—è —Å PeerJS –∞–≤—Ç–æ—Ä–∞
            const conn = peer.connect(authorData.peerId);

            let receivedSize = 0;
            let totalSize = 0;
            let chunks = [];
            let startTime = Date.now();

            conn.on('open', () => {
                log("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∞–≤—Ç–æ—Ä—É. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ñ–∞–π–ª...", 'success');
                statusEl.innerText = "–ó–∞–ø—Ä–æ—Å —Ñ–∞–π–ª–∞...";
                conn.send({ type: 'REQUEST_FILE', gameId: gameId });
            });

            conn.on('data', (data) => {
                if (data.type === 'META') {
                    totalSize = data.size;
                    statusEl.innerText = `–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${data.name}`;
                    log(`–ü–æ–ª—É—á–µ–Ω—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ${data.name}, ${data.size} bytes`, 'info');
                }
                else if (data.type === 'CHUNK') {
                    chunks.push(data.data);
                    receivedSize += data.data.byteLength;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    const percent = (receivedSize / totalSize) * 100;
                    barEl.style.width = `${percent}%`;
                    document.getElementById('dl-percent').innerText = Math.round(percent) + '%';
                    
                    // –°–∫–æ—Ä–æ—Å—Ç—å
                    const elapsed = (Date.now() - startTime) / 1000;
                    const speed = (receivedSize / 1024 / 1024) / elapsed;
                    document.getElementById('dl-speed').innerText = speed.toFixed(1) + ' MB/s';
                }
                else if (data.type === 'END') {
                    statusEl.innerText = "–°–±–æ—Ä–∫–∞ —Ñ–∞–π–ª–∞...";
                    log("‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...", 'success');
                    
                    const blob = new Blob(chunks);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // –ò–º—è —Ñ–∞–π–ª–∞ –±–µ—Ä–µ–º –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∏–≥—Ä—ã –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
                    a.download = "game_downloaded_via_diesel_p2p"; 
                    a.click();
                    
                    setTimeout(() => modal.classList.add('hidden'), 2000);
                    conn.close();
                }
                else if (data.type === 'ERROR') {
                    alert("–û—à–∏–±–∫–∞ –æ—Ç —Ö–æ—Å—Ç–∞: " + data.message);
                    modal.classList.add('hidden');
                }
            });

            conn.on('error', (err) => {
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err);
                modal.classList.add('hidden');
            });
        }

        // –£—Ç–∏–ª–∏—Ç—ã UI
        let activeConns = 0;
        function updateConnCount(n) {
            activeConns += n;
            document.getElementById('conn-count').innerText = activeConns;
        }
        function updateHostingCount() {
            document.getElementById('hosting-count').innerText = Object.keys(hostedFiles).length;
        }

    </script>
</body>
</html>
